---
title: "6. 任务管理"
---

## 6.1 系统进程介绍

系统进程包括了多个用户的多个工作任务，操作系统本身的核心程序等。Alibaba Cloud Linux 2 允许这些进程同时运行。用户可以通过在Alibaba Cloud Linux 2提供的shell中执行自己的任务，也可以通过cron等工具定期执行任务。用户也可以通过系统进程管理软件，监控和控制自己和其它用户的任务。

## 6.2 系统进程管理

Alibaba Cloud Linux 2 提供了ps、top、kill等工具，用于管理进程，尤其是后台运行的服务进程。

### 6.2.1 进程查看

管理员时常需要监控进程的运行情况。利用ps、top等软件，可以查看进程名称、参数、状态、资源消耗、运行时间、用户等信息。

**ps** 

ps命令功能强大，有很多选项。常用的选项组合为：

```
# 列出系统上所有进程的详细信息
ps aux

# 树状显示所有进程
ps axjf

# 列出用户foouser拥有的进程
ps -aufoouser

# 列出所有进程的pid,user,command这3列信息
ps -eo pid,user,command

# 与grep命令组合，列出包含了httpd字样的进程
ps aux | grep '[h]ttpd'
```

ps aux 的结果包含了多列，每列的含义如下：

| 列名    | 含义                             |
| ------- | -------------------------------- |
| USER    | 用户名                           |
| PID     | 进程号                           |
| %CPU    | CPU占用率（百分比）              |
| %MEM    | 内存占用率（百分比）             |
| VSZ     | 虚拟内存大小                     |
| RSS     | 实际内存大小                     |
| TTY     | 前台进程所属终端                 |
| STAT    | 进程状态                         |
| START   | 进程启动时间                     |
| TIME    | 进程运行的总CPU时间              |
| COMMAND | 运行的命令行，包括了程序名和参数 |

 

**top**

top的特点是可以实时动态查看进程信息，允许管理员键盘交互控制top的输出。通常不用指定任何选项，直接运行top命令。

top命令的输出也包含多列，且与ps基本相同。额外的 NI 和 PR 均为进程优先级信息。

### 6.2.2 进程终止

有时因为各种原因需要提前终止进程，而不等待进程自行退出。例如资源消耗过多的进程，死锁的进程等。

此时需要使用 kill 命令，通过向程序发送信号（signal），达到提前终止程序的目的。kill命令的用法为：

```
kill [-SIGNAL] <PID>
```

PID为需要终止的进程的进程号，使用6.2.1中介绍的工具，可以得到进程的进程号。

SIGNAL为需要发送的信号名或信号数字。用于终止进程的信号有两个：SIGTERM（15），SIGKILL（9）。

SIGTERM和SIGKILL的区别在于：SIGTERM允许进程做退出前的工作，例如资源回收、释放等；SIGKILL强制进程立即结束。因此SIGTERM无法终止的进程，需要使用SIGKILL来终止。

例如， 以下命令强制4264号进程结束。

```
kill -SIGKILL 4264
```

另外，kill命令还用于核心转储、程序暂停和唤醒等场景。更多可用信号可使用kill -l命令查看。

 

## 6.3 周期性任务管理

周期性任务管理是系统管理员广泛使用的功能，常用于包含不仅限于以下场景：数据备份、系统和硬件状态检查、安全扫描。Alibaba Cloud Linux 2 提供的周期性任务管理工具是cron。它提供了周期执行任务的守护进程，以及一个简单易用的命令行接口（crontab）。

### 6.3.1 守护进程

守护进程负责运行配置文件配置的周期性任务。它们包括两部分：

1. 用户周期性任务。

2. 系统周期性任务。

用户周期性任务通过前面提到的crontab命令行接口来修改，配置文件保存在/var/spool/cron/<user>下。

系统周期性任务需要使用编辑器修改，配置文件保存在/etc/crontab下。

### 6.3.2 用户周期性任务

**crontab****工具**

使用crontab可以进行周期性任务的增删改查操作，具体用法如下

crontab [-u <user>] -l # 列出指定用户的所有任务

crontab [-u <user>] -r # 删除指定用户的所有任务

crontab [-u <user>] -e # 弹出编辑器，并修改指定用户的列表。修改后立即生效。

crontab [-u <user>] <file> # 用指定的文件更新用户的列表

省略-u表示使用当前用户的周期性任务列表

例如，如果权限满足，可以使用以下命令修改root用户的任务列表：

```
crontab -u root -e
```

**配置格式**

配置文件每一行包含一个任务，每一个任务包含6个参数：分 小时 日 月 周几 命令 。

最后一个参数表示执行的任务。前5个参数用于表示时间和间隔，时间和间隔可以使用以下记号：

| 记号 | 作用                                                         |
| ---- | ------------------------------------------------------------ |
| *    | 每个时间点                                                   |
| 数字 | 某一时间点                                                   |
| -    | 连续时间段                                                   |
| ,    | 间隔时间范围。用于将多个时间点和时间段，组合成间隔的时间范围。 |
| /    | 指定连续时间段里的频率，即每隔多少个时间点。不指定则表示每个时间点。 |
| 其它 | 周几还可以等价地写作sun,mon,tue,wed,thu,fri,sat；  月还可以等价地写作jan,feb,.. |

通过灵活组合这些记号，可以表示出各种执行间隔。例如：

```
* * * * * CMD   # 每分钟执行一次CMD

30 08 10 06 * CMD # 每年的6月10日 08:30，执行一次CMD

00 11,16 * * * CMD # 每天的11:00，和16:00执行CMD

00 09-18 * * * CMD # 每天的09:00 ~ 18:00的每个整点执行CMD

 00-30/05 * * * * CMD # 每小时的前半个小时，每10分钟执行一次CMD

*/05 * * * * CMD   # 每10分钟执行一次CMD
```

 

### 6.3.3 系统周期性任务 

**配置格式**

格式与用户周期性任务略有不同：

每一个任务包含7个参数：分 小时 日 月 周几 用户 命令 。额外的用户参数，可以用于指定执行命令的用户。

配置文件还包含几个环境变量： SHELL 、 PATH 和 MAILTO。其中任务执行时，将通过邮件通知 MAILTO 指定的管理员。

例如下面例子：

```
 1 SHELL=/bin/bash
 2 PATH=/sbin:/bin:/usr/sbin:/usr/bin
 3 MAILTO=root
 4
 5 # For details see man 4 crontabs

 7 # Example of job definition:
 8 # .---------------- minute (0 - 59)
 9 # | .------------- hour (0 - 23)
10 # | | .---------- day of month (1 - 31)
11 # | | | .------- month (1 - 12) OR jan,feb,mar,apr ...
12 # | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
13 # | | | | |
14 # * * * * * user-name command to be executed
15 01 * * * * root run-parts /etc/cron.hourly

16 02 4 * * * root run-parts /etc/cron.daily

17 22 4 * * 0 root run-parts /etc/cron.weekly

18 42 4 1 * * root run-parts /etc/cron.monthly
```

run-parts是一个遍历执行目录下面的所有脚本的工具。

该配置文件分别定义了每小时、每天、每周、每月的定时任务，这些任务均使用root用户执行。管理员可以将脚本文件放入/etc/cron.*的对应目录下，实现定期执行的目的。